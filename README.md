# JoinRender-Flow

<p align="center">
  <img src="https://img.shields.io/badge/React-18.2-61dafb?logo=react" alt="React">
  <img src="https://img.shields.io/badge/TypeScript-5.3-3178c6?logo=typescript" alt="TypeScript">
  <img src="https://img.shields.io/badge/Vite-5.0-646cff?logo=vite" alt="Vite">
  <img src="https://img.shields.io/badge/Zustand-4.5-orange" alt="Zustand">
  <img src="https://img.shields.io/license/Apache-2.0-blue" alt="License">
</p>

<p align="center">
  <b>一个现代化的可视化节点编程工具，专为创意艺术工作者设计</b>
</p>

<p align="center">
  像搭乐高一样创作 AI 艺术 | 支持 ComfyUI 插件系统 | 角色一致性锁定
</p>

---

## 📸 界面预览

### 主界面
```
┌─────────────────────────────────────────────────────────────────────┐
│  ┌──────────┐                                      ┌──────────────┐ │
│  │          │     ┌─────────────────────┐          │              │ │
│  │  侧边栏   │     │      工具栏          │          │   属性面板   │ │
│  │          │     └─────────────────────┘          │              │ │
│  │ ┌──────┐ │                                      │  节点属性    │ │
│  │ │输入  │ │  ┌─────────┐    ┌─────────┐         │  参数配置    │ │
│  │ │节点  │ │  │ 文本输入 │───▶│  LLM   │         │              │ │
│  │ └──────┘ │  └─────────┘    └────┬────┘         │              │ │
│  │ ┌──────┐ │                      │               │              │ │
│  │ │LLM   │ │                      ▼               │              │ │
│  │ │节点  │ │  ┌─────────┐    ┌─────────┐         │              │ │
│  │ └──────┘ │  │角色参考  │───▶│图像生成 │         │              │ │
│  │ ┌──────┐ │  └─────────┘    └────┬────┘         │              │ │
│  │ │媒体  │ │                      │               │              │ │
│  │ │节点  │ │                      ▼               │              │ │
│  │ └──────┘ │               ┌─────────┐           │              │ │
│  │ ┌──────┐ │               │图像输出  │           │              │ │
│  │ │输出  │ │               └─────────┘           │              │ │
│  │ │节点  │ │                                      │              │ │
│  │ └──────┘ │     ┌────────────────────┐          │              │ │
│  └──────────┘     │ 缩放控制  100%  +-  │          └──────────────┘ │
│                   └────────────────────┘                           │
└─────────────────────────────────────────────────────────────────────┘
```

### 节点连接示例
```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│  📝 文本输入 │      │  🧠 LLM处理  │      │  📋 JSON分离 │
│             │      │             │      │             │
│ [文本框]    │      │ [系统提示词] │      │             │
│             │      │             │      │ ○ 提示词1   │
│        文本 ●──────▶○ 输入文本   │      │ ○ 提示词2   │
│             │      │        输出 ●──────▶○ JSON文本   │
└─────────────┘      └─────────────┘      │ ○ 提示词3   │
                                          └─────────────┘
                                                 │
                     ┌───────────────────────────┼───────────────────────────┐
                     │                           │                           │
                     ▼                           ▼                           ▼
              ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
              │  🎯 角色参考 │            │  🖼️ 图像生成 │            │  🖼️ 图像生成 │
              │             │            │             │            │             │
              │ ○ 角色提示词 │            │ ○ 提示词    │            │ ○ 提示词    │
              │             │            │ 🔒 参考图像 ◀──┐         │ 🔒 参考图像 ◀──┐
              │    参考图像 ●────────────────────────────┘         │             │  │
              └─────────────┘            │        图像 ●            └─────────────┘  │
                     │                   └─────────────┘                    │        │
                     │                                                      │        │
                     └──────────────────────────────────────────────────────┴────────┘
```

---

## ✨ 核心特性

### 🧱 像乐高一样简单
- **拖拽式操作**：从侧边栏拖拽节点到画布，连接端口即可构建工作流
- **可视化连线**：彩色连接线清晰展示数据流向
- **实时预览**：节点内嵌预览，所见即所得

### 🎯 角色一致性锁定（核心创新）
- **Reference Image 机制**：通过参考图像输入端口（🔒标记）锁定角色外观
- **全局角色参考**：一次生成角色参考图，全流程保持一致
- **物理定律级约束**：确保同一角色在不同镜头中外观统一

### 🔌 ComfyUI 插件系统
- **完全兼容**：支持加载 ComfyUI 节点定义
- **类型映射**：自动转换 ComfyUI 数据类型（latent、model、clip、vae 等）
- **Widget 支持**：slider、combo、toggle 等控件完美呈现

### 🎨 现代化 UI/UX
- **深色主题**：专业级深色界面，减少视觉疲劳
- **可调整布局**：侧边栏和属性面板宽度可拖拽调整
- **浮动工具栏**：可拖拽定位的工具栏
- **缩放控制**：支持鼠标滚轮缩放和按钮控制

---

## 🆚 与传统 ComfyUI 对比

| 特性 | JoinRender-Flow | 传统 ComfyUI |
|------|-----------------|--------------|
| **学习曲线** | ⭐ 极低 - 拖拽即用 | ⭐⭐⭐⭐ 陡峭 - 需要理解底层概念 |
| **界面设计** | 现代化深色 UI，专业美观 | 功能性界面，视觉较朴素 |
| **节点分类** | 4 大类：输入/LLM/媒体/输出 | 10+ 类别，节点繁多 |
| **角色一致性** | ✅ 内置 Reference Image 机制 | ❌ 需手动配置 IP-Adapter |
| **目标用户** | 创意艺术工作者、设计师 | 技术用户、开发者 |
| **工作流理念** | 从创意到成品的完整链路 | 底层图像处理管道 |
| **插件兼容** | ✅ 支持 ComfyUI 节点 | 原生支持 |
| **技术栈** | React + TypeScript + Vite | Python + LiteGraph |
| **部署方式** | 纯前端，可静态部署 | 需要 Python 后端 |

### 设计理念差异

**传统 ComfyUI：**
```
用户 → 理解 Latent/VAE/CLIP 概念 → 手动连接采样器 → 配置参数 → 生成
       ↑                                                    ↓
       └────────────── 反复调试 ◀─────────────────────────────┘
```

**JoinRender-Flow：**
```
用户 → 输入创意文本 → LLM 自动转换 → 一键生成 → 角色一致的系列图像
       ↑                                              ↓
       └────────────── 快速迭代 ◀────────────────────┘
```

---

## 📦 节点类型

### 输入节点 (Input)
| 节点 | 图标 | 描述 |
|------|------|------|
| 文本输入 | 📝 | 输入文本，可以是小说片段、角色描述等 |
| 图像上传 | 🖼️ | 上传图像文件 |
| 视频上传 | 🎬 | 上传视频文件 |

### LLM 节点 (大脑节点)
| 节点 | 图标 | 描述 |
|------|------|------|
| LLM 处理 | 🧠 | 将小说语言转换为标准 JSON 格式的镜头语言 |
| 提示词增强 | ✨ | 将基础提示词转换为详细、有效的提示词 |
| 图像分析 | 👁️ | 自动分析图像并生成描述 |
| JSON 分离器 | 📋 | 解析 JSON 并分离出多个提示词 |

### 媒体模型节点 (Media)
| 节点 | 图标 | 描述 |
|------|------|------|
| 角色参考生成 | 🎯 | 生成角色参考图（T-Pose），确保角色一致性 |
| 图像生成 | 🖼️ | 图像生成，支持参考图像输入 |
| 高级图像生成 | ✨ | 高级图像生成，支持更多参数 |
| 视频生成 | 🎬 | 将静态图转成视频 |
| 首尾帧插值 | 🎥 | 从首尾帧生成视频 |
| 图像变体 | 🔄 | 生成图像变体，保持角色一致性 |
| 风格迁移 | 🎨 | 风格迁移 |
| 背景移除 | ✂️ | 移除图像背景 |
| 图像放大 | 🔍 | 图像超分辨率放大 |

### 输出节点 (Output)
| 节点 | 图标 | 描述 |
|------|------|------|
| 图像输出 | 📤 | 图像输出/预览 |
| 视频输出 | 🎞️ | 视频输出/预览 |
| 分镜板输出 | 🎬 | 分镜板输出 |

---

## 🔧 技术架构

```
src/
├── App.tsx                 # 应用主入口
├── main.tsx               # React 挂载点
├── components/            # UI 组件
│   ├── Canvas.tsx         # 画布组件（缩放、平移、拖放）
│   ├── Node.tsx           # 节点组件（渲染、交互）
│   ├── Connections.tsx    # 连接线组件（贝塞尔曲线）
│   ├── Sidebar.tsx        # 侧边栏（节点列表）
│   ├── Toolbar.tsx        # 工具栏（运行、清空等）
│   ├── PropertiesPanel.tsx # 属性面板
│   ├── PluginPanel.tsx    # 插件管理面板
│   ├── TemplatePanel.tsx  # 模板面板
│   └── ZoomControls.tsx   # 缩放控制
├── store/
│   └── index.ts           # Zustand 状态管理
├── types/
│   └── index.ts           # TypeScript 类型定义
├── nodes/
│   └── definitions.ts     # 内置节点定义
├── plugins/
│   ├── PluginManager.ts   # 插件管理器
│   ├── builtinComfyNodes.ts # 内置 ComfyUI 节点
│   └── index.ts
├── templates/
│   └── index.ts           # 工作流模板
└── styles/
    └── index.css          # 全局样式
```

### 状态管理

使用 Zustand 进行状态管理，核心状态包括：

- **nodes**: 节点实例列表
- **connections**: 连接线列表
- **canvas**: 画布状态（缩放、偏移）
- **connectionState**: 连接中状态
- **executionStates**: 执行状态
- **selectedNodeIds**: 选中的节点

### 数据类型

支持的端口类型：
- 基础类型：`image`、`video`、`text`、`any`
- ComfyUI 类型：`latent`、`model`、`clip`、`vae`、`conditioning`、`mask`、`control_net`、`int`、`float`、`boolean`、`combo`

---

## 🚀 快速开始

### 环境要求
- Node.js 18+
- npm 或 yarn

### 安装

```bash
# 克隆仓库
git clone https://github.com/Joinsyna-Co-Ltd/JoinRender-Flow.git

# 进入目录
cd JoinRender-Flow

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

### 构建

```bash
# 构建生产版本
npm run build

# 预览构建结果
npm run preview
```

---

## 📖 使用指南

### 基本操作

1. **添加节点**：从左侧边栏拖拽节点到画布
2. **连接节点**：从输出端口（右侧）拖拽到输入端口（左侧）
3. **移动节点**：拖拽节点标题栏
4. **删除节点**：点击节点右上角的 ✕ 按钮
5. **画布操作**：
   - 平移：在空白处拖拽
   - 缩放：鼠标滚轮或右下角缩放控制
6. **运行工作流**：点击工具栏的 ▶️ 按钮

### 创建角色一致的图像序列

```
步骤 1: 添加「文本输入」节点，输入角色描述
        ↓
步骤 2: 连接到「LLM 处理」节点，转换为镜头语言
        ↓
步骤 3: 添加「角色参考生成」节点，生成 T-Pose 参考图
        ↓
步骤 4: 添加多个「图像生成」节点，将参考图连接到 🔒 端口
        ↓
步骤 5: 运行工作流，获得角色一致的系列图像
```

---

## 🔌 插件开发

### 注册自定义节点

```typescript
import { PluginManager } from './plugins';

const myPlugin = {
  id: 'my-plugin',
  name: '我的插件',
  version: '1.0.0',
  description: '自定义节点插件',
  enabled: true,
  nodes: [
    {
      name: 'MyCustomNode',
      display_name: '自定义节点',
      category: 'custom',
      input: {
        required: {
          image: ['IMAGE'],
          strength: ['FLOAT', { default: 0.5, min: 0, max: 1, step: 0.01 }],
        },
      },
      output: ['IMAGE'],
      output_name: ['输出图像'],
    },
  ],
};

PluginManager.registerPlugin(myPlugin);
```

---

## 📄 许可证

本项目采用 [Apache-2.0](LICENSE) 许可证。

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

<p align="center">
  <b>JoinRender-Flow</b> - 让 AI 创作像搭积木一样简单
</p>

<p align="center">
  Made with ❤️ by <a href="https://github.com/Joinsyna-Co-Ltd">Joinsyna Co., Ltd</a>
</p>
